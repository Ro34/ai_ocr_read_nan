# Flutter 后端 API 配置指南

## 功能说明

已实现完整的后端 API 地址配置功能,支持以下特性:

### ✅ 已实现的功能

1. **后端地址配置**
   - 文本输入框手动配置
   - 常用地址快捷选择
   - 地址历史记录 (最多保存 5 条)
   - 输入验证 (必须是有效的 http/https URL)
   - 持久化保存到 SharedPreferences

2. **连接测试**
   - 一键测试后端健康检查 (/health)
   - 显示响应时间
   - 详细的错误提示和诊断信息
   - 实时状态反馈

3. **用户体验优化**
   - Material Design 3 风格界面
   - 彩色状态提示 (成功绿色,失败红色)
   - 加载指示器
   - SnackBar 提示消息
   - 图标和视觉反馈

4. **独立设置页面**
   - 专门的设置页面 (`settings_page.dart`)
   - 详细的配置说明
   - 常用预设地址
   - 历史记录管理

## 使用方式

### 方式一: 主页面快捷配置

在主页面的"后端 API 地址"卡片中:

1. **输入地址**: 在文本框中输入后端 URL
2. **快捷选择**: 点击"本机"、"局域网"、"WiFi"等快捷按钮
3. **保存**: 点击"保存"按钮保存配置
4. **测试**: 点击"测试连接"验证配置

### 方式二: 设置页面完整配置

点击右上角的设置图标 (⚙️) 进入设置页面:

1. **查看说明**: 阅读配置说明和注意事项
2. **选择预设**: 
   - 本机 (模拟器): `http://localhost:8000`
   - 本机 (Android): `http://10.0.2.2:8000`
   - 局域网示例: `http://192.168.0.90:8000`
3. **使用历史**: 从最近使用的地址中快速选择
4. **测试连接**: 查看详细的连接测试结果
5. **保存设置**: 保存后自动同步到主页面

## 配置示例

### 真机测试 (推荐)

1. 确保手机和电脑在同一 WiFi 网络
2. 查看电脑的局域网 IP:
   - macOS: `系统设置 -> 网络 -> Wi-Fi -> 详细信息`
   - Windows: `ipconfig`
   - Linux: `ifconfig` 或 `ip addr`
3. 配置地址: `http://你的电脑IP:8000`
   - 例如: `http://192.168.0.90:8000`

### iOS 模拟器

```
http://localhost:8000
```

### Android 模拟器

```
http://10.0.2.2:8000
```
(10.0.2.2 是 Android 模拟器访问电脑 localhost 的特殊地址)

## UI 改进亮点

### 主页面改进

1. **图标增强**: 添加云图标和链接图标
2. **芯片显示**: 当前地址用醒目的芯片展示
3. **快捷操作**: ActionChip 提供快速地址切换
4. **按钮分组**: 保存和测试按钮并排显示
5. **实时反馈**: 输入时显示清除按钮

### 设置页面特色

1. **配置说明卡片**: 醒目的信息图标和使用说明
2. **预设地址**: 图标化的快捷选择按钮
3. **历史记录**: 列表展示最近使用的地址
4. **测试结果卡片**: 
   - 绿色背景显示成功
   - 红色背景显示失败
   - 加载动画显示测试中
5. **详细诊断**: 针对不同错误类型提供具体建议

## 状态提示

### 成功状态 (绿色)
- ✅ 地址保存成功
- ✅ 连接测试成功
- 显示响应时间

### 失败状态 (红色)
- ❌ 地址格式错误
- ❌ 连接失败
- ❌ 网络超时
- 提供具体错误原因和解决建议

### 警告状态 (橙色)
- ⚠️ 地址为空
- ⚠️ 格式不正确

## 代码结构

```
lib/
├── main.dart              # 主页面,包含简化的配置区域
├── settings_page.dart     # 独立的设置页面
└── camera_capture_page.dart
```

### 关键函数

- `_initBackendBaseUrl()`: 初始化加载保存的地址
- `_applyBackendUrl()`: 保存地址到 SharedPreferences
- `_testBackendHealth()`: 测试后端健康检查
- `_analyzeWithOcr()`: 使用配置的地址调用 OCR API
- `_analyzeWithVlm()`: 使用配置的地址调用 VLM API

## 持久化存储

使用 SharedPreferences 存储:

```dart
// 保存当前地址
await sp.setString('backend_base_url', url);

// 保存历史记录
await sp.setStringList('recent_backend_urls', recentList);
```

## 注意事项

1. **网络权限**: 确保 `AndroidManifest.xml` 中有网络权限
2. **HTTP 明文**: Android 9+ 需要配置 `network_security_config.xml` 允许 HTTP
3. **局域网访问**: 防火墙可能需要允许端口 8000
4. **CORS**: 后端需要配置 CORS 允许跨域请求

## 测试步骤

1. 启动后端服务: `cd ocr_ai_backend && uv run uvicorn main:app --reload --port 8000`
2. 打开 Flutter 应用
3. 点击设置图标进入设置页面
4. 配置后端地址
5. 点击"测试连接"验证
6. 保存设置
7. 返回主页拍照测试 OCR/VLM 功能

## 故障排除

### 问题: 连接超时

**原因**: 
- 后端服务未启动
- 防火墙阻止连接
- IP 地址错误

**解决**:
1. 检查后端服务是否运行
2. 使用浏览器访问 `http://你的IP:8000/health`
3. 检查防火墙设置
4. 确认手机和电脑在同一网络

### 问题: 无法解析域名

**原因**: 
- IP 地址拼写错误
- DNS 问题

**解决**:
1. 使用 IP 地址而非域名
2. 检查地址格式是否正确

### 问题: Android HTTP 请求失败

**原因**: 
- Android 9+ 默认禁止 HTTP 明文传输

**解决**:
在 `android/app/src/main/AndroidManifest.xml` 添加:
```xml
android:usesCleartextTraffic="true"
```

## 未来可扩展功能

- [ ] 多个后端配置切换
- [ ] 自动发现局域网服务
- [ ] HTTPS 证书配置
- [ ] API 密钥管理
- [ ] 请求超时配置
- [ ] 自定义端点配置
